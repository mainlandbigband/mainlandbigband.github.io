<!doctype html>
<html>
<head>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
	<style>
		@media print{@page {size: landscape}}

		@media print {
			html,body {
				margin: 0;
			}
			table th, table td {
				-webkit-print-color-adjust: exact;
			}
			.pagebreak {
				clear: both;
				page-break-after: always;
			}
		}

		#target table * {
			font-size: 12px !important;
		}
	</style>
</head>

	<title>MBB Contact List</title>
<h3>Mainland Big Band Contact List <span id="date">Date</span></h3>

<div id="target"></div>
<script id="stoogesTemplate" type="x-tmpl-mustache">
<table class="table table-sm table-striped">
  <thead class="thead-dark">
    <th>Name</th><th>ICE</th><th>Address</th><th nowrap>Home Phone</th><th>Mobile</th><th>Email</th><th>Instrument</th>
  </thead>
  <tbody>
{{#stooges}}
	<tr>
		<td nowrap>{{name}}</td>
		<td>{{ice}}</td>
		<td>{{address}}</td>
		<td nowrap>{{homePhone}}</td>
		<td nowrap>{{mobilePhone}}</td>
		<td>{{email}}</td>
		<td>{{instrument}}</td>
	</tr>
{{/stooges}}
  </tbody>
<table>
</script>
<script id="contactListTemplate" type="x-tmpl-mustache">
	{{{currentStooges}}}
	<div class="pagebreak"> </div>
	<h4>Former Players</h4>
	{{{formerStooges}}}
</script>
	
<script src="https://unpkg.com/mustache@latest"></script>
<script async defer>

	async function render(stooges) {
		const [currentStooges, formerStooges] = stooges.reduce(([current, former], stooge) => {
			if (stooge.instrument?.startsWith('Former')) {
			  former.push(stooge);
			} else {
			  current.push(stooge);
			}
		    return [current, former];
		}, [[], []]);
		
		const stoogesTemplate = document.getElementById('stoogesTemplate').innerHTML;
		const currentStoogesRendered = Mustache.render(stoogesTemplate, { stooges: currentStooges });
		const formerStoogesRendered = Mustache.render(stoogesTemplate, { stooges: formerStooges });
		const contactListTemplate = document.getElementById('contactListTemplate').innerHTML;
		document.getElementById('target').innerHTML = Mustache.render(contactListTemplate, {currentStooges: currentStoogesRendered, formerStooges: formerStoogesRendered});
		const currentMonth = new Intl.DateTimeFormat('en-nz', {month: 'long', year: 'numeric'}).format(new Date());
		document.getElementById('date').innerHTML = currentMonth;
		document.title += " " + currentMonth;
		
		print();
	}

	async function getGroupIdByName(groupName, accessToken) {
		const res = await fetch('https://people.googleapis.com/v1/contactGroups', {
			headers: { Authorization: `Bearer ${accessToken}` },
		});
		const data = await res.json();

		const group = data.contactGroups.find(g => g.formattedName.toLowerCase() === groupName.toLowerCase());
		return group ? group.resourceName : null;
	}

	async function fetchAndFilterContacts(groupId, accessToken) {
		let allFilteredContacts = [];
		let nextPageToken = null;

		do {
			const url = new URL('https://people.googleapis.com/v1/people/me/connections');
			url.searchParams.set('personFields', 'names,emailAddresses,phoneNumbers,addresses,organizations,biographies,memberships');
			url.searchParams.set('pageSize', '500'); // You can adjust this between 1 and 1000
			if (nextPageToken) {
				url.searchParams.set('pageToken', nextPageToken);
			}

			const res = await fetch(url.toString(), {
				headers: { Authorization: `Bearer ${accessToken}` },
			});

			if (!res.ok) {
				console.error(`Failed to fetch connections: ${res.statusText}`);
				document.getElementById('output').textContent = `Error: ${res.statusText}`;
				return;
			}

			const data = await res.json();

			const filteredContacts = (data.connections || []).filter(person =>
					person.memberships?.some(m => m.contactGroupMembership?.contactGroupResourceName === groupId)
			);

			allFilteredContacts = allFilteredContacts.concat(filteredContacts);

			nextPageToken = data.nextPageToken;
		} while (nextPageToken);

		return allFilteredContacts;
	}


	async function fetchContacts(accessToken) {
		const group = await getGroupIdByName('MBB', accessToken);

		const contactDetails = await fetchAndFilterContacts(group, accessToken);
		const convertedContacts = contactDetails.map(person => {
			const address = person.addresses?.[0];
			const formattedAddress = address
					? [address.streetAddress, address.city, address.region, address.postalCode]
							.filter(Boolean) // remove undefined/null
							.join(' ')
					: '';

			const homePhone = person.phoneNumbers?.find(p => (p.type || '').toLowerCase() === 'home' || (p.formattedType || '').toLowerCase() === 'home')?.value || '';
			const mobilePhone = person.phoneNumbers?.find(p => (p.type || '').toLowerCase() === 'mobile' || (p.formattedType || '').toLowerCase() === 'mobile')?.value || '';

			return {
				name: person.names?.[0]?.displayName || '',
				address: formattedAddress,
				homePhone: homePhone,
				mobilePhone: mobilePhone,
				email: person.emailAddresses?.[0]?.value || '',
				instrument: person.organizations?.[0]?.title || '',
				ice: person.biographies?.[0]?.value.replace(/\\/g, '').split('\n')[0].replace('ICE: ', '') || ''
			};
		}).sort((a, b) => a.name.localeCompare(b.name));

		render(convertedContacts);

	}

	function requestAccess() {
		const tokenClient = google.accounts.oauth2.initTokenClient({
			client_id: '838759855531-2i8gc6cg8srcq828m504bitk1r1gogcb.apps.googleusercontent.com',
			scope: 'https://www.googleapis.com/auth/contacts.readonly',
			prompt: '',
			callback: (tokenResponse) => {
				fetchContacts(tokenResponse.access_token);
			},
		});
		tokenClient.requestAccessToken();
	}


	function waitForGoogle() {
		try {
			requestAccess()
		} catch (error) {
			console.log('No Google');
			setTimeout(waitForGoogle, 500);
		}
	}
	waitForGoogle();
</script>
</html>